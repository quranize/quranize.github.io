<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">

    <title>Mini Quranize</title>

    <link rel="stylesheet" href="styles/bulma.min.css">
    <link rel="stylesheet" href="assets/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="assets/fontawesome/css/brands.min.css">
    <link rel="stylesheet" href="assets/fontawesome/css/solid.min.css">
    <style>
        [v-cloak] {
            display: none;
        }

        @font-face {
            font-family: hafs;
            font-display: swap;
            src: url("fonts/hafs/hafs.woff2") format("woff2"),
                url("fonts/hafs/hafs.woff") format("woff"),
                url("fonts/hafs/hafs.otf") format("opentype");
        }

        .quran-text {
            font-family: hafs;
            font-size: 1.15em;
            line-height: 2.35em;
            direction: rtl;
        }
    </style>

    <script src="scripts/vue.global.prod.js"></script>
    <script type="module">
        import init, { Quranize } from "./scripts/quranize.js";
        Vue.createApp({
            data() {
                return {
                    keyword: "",
                    encodeResults: [],
                    quranize: undefined,
                    suraNames: ["الفاتحة", "البقرة", "آل عمران", "النساء", "المائدة", "الأنعام", "الأعراف", "الأنفال", "التوبة", "يونس", "هود", "يوسف", "الرعد", "ابراهيم", "الحجر", "النحل", "الإسراء", "الكهف", "مريم", "طه", "الأنبياء", "الحج", "المؤمنون", "النور", "الفرقان", "الشعراء", "النمل", "القصص", "العنكبوت", "الروم", "لقمان", "السجدة", "الأحزاب", "سبإ", "فاطر", "يس", "الصافات", "ص", "الزمر", "غافر", "فصلت", "الشورى", "الزخرف", "الدخان", "الجاثية", "الأحقاف", "محمد", "الفتح", "الحجرات", "ق", "الذاريات", "الطور", "النجم", "القمر", "الرحمن", "الواقعة", "الحديد", "المجادلة", "الحشر", "الممتحنة", "الصف", "الجمعة", "المنافقون", "التغابن", "الطلاق", "التحريم", "الملك", "القلم", "الحاقة", "المعارج", "نوح", "الجن", "المزمل", "المدثر", "القيامة", "الانسان", "المرسلات", "النبإ", "النازعات", "عبس", "التكوير", "الإنفطار", "المطففين", "الإنشقاق", "البروج", "الطارق", "الأعلى", "الغاشية", "الفجر", "البلد", "الشمس", "الليل", "الضحى", "الشرح", "التين", "العلق", "القدر", "البينة", "الزلزلة", "العاديات", "القارعة", "التكاثر", "العصر", "الهمزة", "الفيل", "قريش", "الماعون", "الكوثر", "الكافرون", "النصر", "المسد", "الإخلاص", "الفلق", "الناس"],
                    translations: {},
                };
            },
            methods: {
                initQuranize() {
                    return init().then(() => {
                        this.quranize = new Quranize(5);
                        this.$refs.keyword.focus();
                    });
                },
                initTranslations() {
                    return fetch("translations/id.indonesian")
                        .then(response => response.text())
                        .then(text => {
                            text.split("\n")
                                .map(l => l.split("|"))
                                .filter(e => e.length == 3)
                                .forEach(e => this.translations[`${e[0]}:${e[1]}`] = e[2]);
                            this.encodeResults.forEach(r => r.locations.forEach(this.setTranslation));
                        });
                },
                setTranslation(location) {
                    if (!location.translation)
                        location.translation = this.translations[`${location.sura_number}:${location.aya_number}`];
                },
                updateKeyword(event) {
                    this.keyword = event.target.value;
                    if (this.quranize)
                        this.encodeResults = this.quranize.encode(this.keyword);
                },
                clickEncodeResult(encodeResult) {
                    encodeResult.expanded ^= true;
                    if (encodeResult.locations.length < 40)
                        encodeResult.locations.forEach(this.clickLocation);
                },
                clickLocation(location) {
                    location.expanded ^= true;
                    this.setTranslation(location);
                },
                toArabicNumber(n) {
                    if (n < 0) return `-${this.toArabicNumber(-n)}`;
                    if (n < 10) return String.fromCharCode(0x0660 + n);
                    return this.toArabicNumber(Math.floor(n / 10)) + this.toArabicNumber(n % 10);
                },
            },
            computed: {
                keywordPlaceholder() {
                    return this.quranize ? "subhanallah" : "preparing the app ...";
                },
            },
            mounted() {
                document.fonts.ready
                    .then(this.initQuranize)
                    .then(this.initTranslations);
            },
        }).mount('#quranize-app');
    </script>
</head>

<body>
    <section class="hero is-info">
        <div class="hero-body">
            <div class="container">
                <p class="title">
                    Mini Quranize
                </p>
                <p class="subtitle">
                    search in the <span class="quran-text">القرآن</span> using alphabet keywords
                </p>
            </div>
        </div>
    </section>

    <section class="section" id="quranize-app" v-cloak>
        <div class="container">
            <div class="block">
                <div class="control has-icons-left">
                    <input type="text" class="input is-rounded"
                        :class="{'is-success': encodeResults.length, 'is-danger': !encodeResults.length && keyword}"
                        @input="updateKeyword" :placeholder="keywordPlaceholder" :disabled="!quranize" ref="keyword">
                    <span class="icon is-left">
                        <i class="fa-solid" :class="quranize ? 'fa-magnifying-glass' : 'fa-gear fa-spin'"></i>
                    </span>
                </div>
            </div>
            <div class="box" v-for="encodeResult in encodeResults">
                <div class="block has-text-centered">
                    <p class="title quran-text">{{ encodeResult.quran }}</p>
                    <button class="button is-small is-rounded" :class="{'is-success': encodeResult.expanded}"
                        @click="clickEncodeResult(encodeResult)">
                        <span class="icon">
                            <i class="fa-solid"
                                :class="encodeResult.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </span>
                        <span>{{ encodeResult.locations.length }}</span>
                    </button>
                </div>
                <div v-if="encodeResult.expanded">
                    <nav class="panel" v-for="location in encodeResult.locations">
                        <p class="panel-heading quran-text has-text-centered">
                            {{ suraNames[location.sura_number - 1] }}:{{ toArabicNumber(location.aya_number) }}
                            <button class="button is-small is-rounded" :class="{'is-success': location.expanded}"
                                @click="clickLocation(location)">
                                <span class="icon">
                                    <i class="fa-solid"
                                        :class="location.expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </span>
                            </button>
                        </p>
                        <label class="panel-block quran-text" v-if="location.expanded">
                            <span>
                                {{ location.before_text }}
                                <mark>{{ location.text }}</mark>
                                {{ location.after_text }}
                            </span>
                        </label>
                        <label class="panel-block" v-if="location.expanded">
                            <progress class="progress" v-if="!location.translation"></progress>
                            {{ location.translation }}
                        </label>
                    </nav>
                </div>
            </div>
        </div>
    </section>
</body>

</html>
